
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tug&#8217;s Blog</title>
  <meta name="author" content="Tug Grall">

  
  <meta name="description" content="Introduction In this post I just want to show how easily is to get
started with Couchbase, and also explain how to “query” the data. The basic
steps &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tgrall.github.io/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tug's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1520374-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tug&#8217;s Blog</a></h1>
  
    <h2>Redis, NoSQL and more&#8230;</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="tgrall.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/06/couchbase-101-install-store-and-query-data/">Couchbase 101 : Install, Store and Query Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-07-06T09:31:00+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>9:31 am</span></time>
        
           | <a href="/blog/2012/07/06/couchbase-101-install-store-and-query-data/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2012/07/06/couchbase-101-install-store-and-query-data/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Introduction</h2>

<p>In this post I just want to show how easily is to get
started with Couchbase, and also explain how to “query” the data. The basic
steps of this tutorial are:</p>

<ol>
<li>Install Couchbase</li>
<li>Create Data</li>
<li>Query Data</li>
</ol>


<p>I will try to post more articles, if I have time to show how to use Couchbase from your applications (starting with Java).</p>

<p>Prerequisites :</p>

<ul>
<li>Could not be simpler : Couchbase 2.0 available <a href="http://www.couchbase.com/downloads-all">here</a>. (Currently in Developer Preview)</li>
</ul>


<h2>Couchbase 101 : Insert and Query data</h2>

<h3>Installation</h3>

<p>I am using Couchbase on Mac OS X, so let me describe the installation in this environment. If you are using other operating system just take a look to the Couchbase documentation.</p>

<p>Couchbase installation is very (very!) fast:</p>

<ol>
<li>Download the Mac OS X Zip file.</li>
<li>Double-click the downloaded Zip installation file to extract the contents. This will create a single file, the Couchbase.app application.</li>
<li>Drag and Drop the Couchbase.app to your chosen installation folder, such as the system Applications folder.</li>
</ol>


<h3>Start and Configure Couchbase Server</h3>

<p>To start Couchbase Server, just double click on the Couchbase Server. Once the server is started, a new icon is added in the OS X Menu to indicate that the Server is up and running.</p>

<p>You can now configure your Couchbase instance, for this you just need to access the Admin Console, available at the following location <a href="http://127.0.0.1:8091/">http://127.0.0.1:8091</a> (change the IP address if needed) or simply by going in the Couchbase menu and click on Open Admin Console entry.</p>

<p><img src="http://4.bp.blogspot.com/-UokiHs1DlFw/T_VpJHmn8KI/AAAAAAAAAUo/oy7bh5w9nOw/s1600/couchbase-menu.png"></p>

<ol>
<li>Welcome Screen : Click Setup</li>
<li>Set the disk and cluster configuration. On my instance I keep the default location for the on disk storage. Just configure the size of the memory usage for your instance, for example 800Mb. So far, we have a single instance, so no need to join a cluster.</li>
<li>Choose to generate sample data. This will be interesting to learn more about data and views.</li>
<li>Create <code>the default</code> bucket (use for testing only). A bucket is used by Couchbase to store data. It could be compared to a “database” in RDBMS world.</li>
<li>Configure update notifications to be alerted when new version of Couchbase is released</li>
<li>Configure the server with a final step with the administrator username and password</li>
<li>When this is done you are automatically redirected to the Admin Console.</li>
</ol>


<p><img src="http://2.bp.blogspot.com/-_a1iynqdk8w/T_VpTwa5qEI/AAAAAAAAAUw/ZGBHZsC6x_8/s320/install-step8.png"></p>

<p>This is it! You are ready to use your Couchbase server.</p>

<p>Couchbase has many interesting features, especially around scalability and elasticity but for not in this article let&rsquo;s focus on the basics :</p>

<ul>
<li>Insert some data and query them</li>
</ul>


<h3>Insert Data</h3>

<p>Couchbase has many ways to manipulate data from you favorite programming language using the different client libraries : Java, Python, PHP, Ruby, .Net, C. For now let&rsquo;s use the Admin Console to create and query data.</p>

<p>Couchbase can store any type of data, but when you need to manipulate some data with a structure the best way is to use JSON Documents. So let&rsquo;s use the console and create documents.</p>

<p>To create new documents in your database, click on the &ldquo;Data Buckets&rdquo; tab. If you have installed the sample you see 2 buckets: <code>default</code> and <code>gamesim-sample</code>.</p>

<p>Let&rsquo;s create a new documents in the <code>default</code> bucket:</p>

<ol>
<li>Click on Documents button</li>
<li>Click on Create Document</li>
<li>Since each document must have an id for example 100.</li>
<li>Couchbase save the document and add some metadata such as &#95;rev, $flags, expiration</li>
<li>Add new attributes to the document that describe an employee : Name, Departement and Salary, then save it. You just need to update the JSON object with values</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Thomas&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;dept&quot;</span><span class="p">:</span> <span class="s2">&quot;Sales&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;salary&quot;</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Repeat the operation with some other employees :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="mi">200</span><span class="o">,</span><span class="n">Jason</span><span class="o">,</span><span class="n">Technology</span><span class="o">,</span><span class="mi">5500</span>
</span><span class='line'>  <span class="mi">300</span><span class="o">,</span><span class="n">Mayla</span><span class="o">,</span><span class="n">Technology</span><span class="o">,</span><span class="mi">7000</span>
</span><span class='line'>  <span class="mi">400</span><span class="o">,</span><span class="n">Nisha</span><span class="o">,</span><span class="n">Marketing</span><span class="o">,</span><span class="mi">9500</span>
</span><span class='line'>  <span class="mi">500</span><span class="o">,</span><span class="n">Randy</span><span class="o">,</span><span class="n">Technology</span><span class="o">,</span><span class="mi">6000</span>
</span><span class='line'>  <span class="mi">501</span><span class="o">,</span><span class="n">Ritu</span><span class="o">,</span><span class="n">Accounting</span><span class="o">,</span><span class="mi">5400</span>
</span></code></pre></td></tr></table></div></figure>


<p>You have now a list of employees in your database. That was easy isn&rsquo;t? Let&rsquo;s now query them.</p>

<h3>Query Data</h3>

<p>Access document directly from its ID</p>

<p>First of all you can quickly access a document using a simple HTTP request using its id. For example to access the Mayla with the id 300 just enter the following URL:</p>

<ul>
<li><code>http://127.0.0.1:8092/default/300</code></li>
</ul>


<p>In this URL you have :</p>

<ul>
<li><code>8092</code> is the Couch API REST port used to access data (where 8091 is the port for the Admin console)</li>
<li><code>default</code> is the bucket in which the document is stored</li>
<li><code>300</code> is the id of the document</li>
</ul>


<h4>Search your data with queries</h4>

<p>So we have seen how you can access one document. But what if my need is :</p>

<ul>
<li>&ldquo;Give me all the employee of the Technology department&rdquo;</li>
</ul>


<p>To achieve such query it is necessary to create views. The views are used by Couchbase server to index and search your data. A view is a Map function written in JavaScript, that will generate a key value list that is compliant with logic you put in the Map function. Note that this key,value is now indexed and sorted by key. This is important when you query your data.</p>

<p>So let&rsquo;s create a new view from the Admin Console:</p>

<ol>
<li>Click on the Views tab (be sure you are on the default bucket)</li>
<li>Click on the &ldquo;Create Development View&rdquo;</li>
<li>Enter the Document and View name:</li>
<li>  Document Name : _design/dev_dept</li>
<li>  View Name : dept</li>
<li>Cick Save</li>
<li>Click on your View to edit it</li>
</ol>


<p>Since we need to provide the list of employees that are part of a the Technology department, we need to create a view that use the <u>department as key</u>, so the map function looks like :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">dept</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Save the view</p>

<p>This function takes the document and create a list that contains the &ldquo;dept&rdquo; as key and null as value. The value itself is not that important in our case. A simple rule will be : do not put too much data in the value since at the end Couchbase server creates an index with this map. Will see that Couchbase allows developer to easily get the document information when accessing a view.</p>

<p>Click on the &ldquo;Show Results&rdquo; button, the result will look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="nt">&quot;rows&quot;</span><span class="p">:[</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;501&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Accounting&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;400&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Marketing&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;100&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Sales&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;300&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we have seen in earlier it is possible to access the document using a single URL, it is the same for views. You can for example access the view we have just created using the following URL:</p>

<ul>
<li><a href="http://127.0.0.1:8092/default/_design/dev_dept/_view/dept">http://127.0.0.1:8092/default/<em>design/dev_dept/</em>view/dept
</a></li>
</ul>


<p>Now it is possible to use query parameter to filter the results using the key parameter with the value entered using a JSON String :</p>

<ul>
<li><a href="http://127.0.0.1:8092/default/_design/dev_dept/_view/dept?key=%22Technology%22">http://127.0.0.1:8092/default/<em>design/dev_dept/</em>view/dept?key=&ldquo;Technology&rdquo;</a></li>
</ul>


<p>The result of this query is now :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="nt">&quot;rows&quot;</span><span class="p">:[</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;300&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You have many other parameters you can use when accessing a view to control the size, the time out, &hellip;. One of them is quite interesting is include_docs that ask Couchbase to include the full content of the document in the result. So if you call :</p>

<ul>
<li><a href="http://127.0.0.1:8092/default/_design/dev_dept/_view/dept?key=%22Technology%22&amp;amp;include_docs=true">http://127.0.0.1:8092/default/<em>design/dev_dept/</em>view/dept?key=&ldquo;Technology&rdquo;&amp;include_docs=true</a></li>
</ul>


<p>The result is :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="nt">&quot;rows&quot;</span><span class="p">:[</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-1de6e6751608eada0000003200000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Jason&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">5500</span><span class="p">}},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;300&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;300&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-f3e44cee742bfae10000003200000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Mayla&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">7000</span><span class="p">}},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-05780359aac8f3790000003200000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Randy&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">6000</span><span class="p">}}</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s now create a little more complicated view to answer the following business requirement:</p>

<ul>
<li>&ldquo;Give me all the employee with a salary between 5000 and 6000&rdquo;</li>
</ul>


<p>So now you know that you need to create a new view with the salary as key let&rsquo;s with the following Map function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">salary</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Couchbase is automatically sorting the key when creating/updating the index so, let&rsquo;s use the <code>startkey</code>  and  <code>endkey</code> parameter when calling the view. So let&rsquo;s call the view with from the following URL:</p>

<ul>
<li><a href="http://127.0.0.1:8092/default/_design/dev_salary/_view/salary?startkey=5000&amp;amp;endkey=6000&amp;amp;include_docs=true">http://127.0.0.1:8092/default/<em>design/dev_salary/</em>view/salary?startkey=5000&amp;endkey=6000&amp;include_docs=true</a></li>
</ul>


<p>The result is :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="nt">&quot;rows&quot;</span><span class="p">:[</span>
</span><span class='line'> <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;100&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;100&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-0f33580d780014060000002e00000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Thomas&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Sales&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">5000</span><span class="p">}},</span>
</span><span class='line'> <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;501&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="mi">5400</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;501&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-b1fe5bc79637720e0000003100000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Ritu&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Accounting&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">5400</span><span class="p">}},</span>
</span><span class='line'> <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="mi">5500</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-1de6e6751608eada0000003200000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Jason&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">5500</span><span class="p">}},</span>
</span><span class='line'> <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="mi">6000</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;doc&quot;</span><span class="p">:{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span><span class="s2">&quot;500&quot;</span><span class="p">,</span><span class="nt">&quot;_rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-05780359aac8f3790000003200000000&quot;</span><span class="p">,</span><span class="nt">&quot;$flags&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;$expiration&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Randy&quot;</span><span class="p">,</span><span class="nt">&quot;dept&quot;</span><span class="p">:</span><span class="s2">&quot;Technology&quot;</span><span class="p">,</span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="mi">6000</span><span class="p">}}</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>In this short article you have learn how to:</p>

<ul>
<li>Install Couchbase*   Create data using the Admin Console</li>
<li>Query data with views</li>
</ul>


<p>When I get more time I will write another article that do the same from Java, and other languages.</p>

<hr />

<p>Note from @ingenthr</p>

<blockquote><p>Nice blog! Note that while querying the REST interface directly is okay, we&rsquo;ve really tried to make it easy by having high-level language support for queries in each of the official client libraries. They&rsquo;re all listed over at <a href="http://www.couchbase.com/develop">http://www.couchbase.com/develop</a></p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/11/exo-platform-internationalization-of-content/">eXo Platform: Internationalization of Content</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-05-11T10:11:18+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>10:11 am</span></time>
        
           | <a href="/blog/2012/05/11/exo-platform-internationalization-of-content/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2012/05/11/exo-platform-internationalization-of-content/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this screencast I explain the support of multi-lingual content of eXo Platform 3.5. The different features that you can see in this video are:</p>

<ul>
<li>Support of multiple languages from URL</li>
<li>Configure the eXo File Explorer to add support for multi-lingual content (new button)</li>
<li>Content translation</li>
<li>Add new language to the platform</li>
</ul>


<iframe width="560" height="420" src="http://www.youtube.com/embed/huzPX3UPvrY?color=white&theme=light"></iframe>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/11/twitter-boostrap-2-and-google-maps/">Twitter Boostrap 2 and Google Maps</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-04-11T14:00:48+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>2:00 pm</span></time>
        
           | <a href="/blog/2012/04/11/twitter-boostrap-2-and-google-maps/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2012/04/11/twitter-boostrap-2-and-google-maps/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Like many developers I am using <a href="http://twitter.github.com/bootstrap/">Twitter Boostrap</a> for my Web applications. Using this framework has been very helpful for me, since I am really not a good HTML/CSS developer. For now, on my site <a href="http://www.resultri.com/">Resultri</a> I am using the default look and feel, will customize it later.</p>

<p>Lately, I wanted to integrate Google Map to my application, and when testing it, I had the bad surprise to see that the Controls and WindowInfo are not printed correctly as you can see in the screen shot below:</p>

<p><img src="http://2.bp.blogspot.com/-J9_mgk-eCmw/T4VCyQ86jFI/AAAAAAAAAT0/rc6uKm5qyQM/s400/Screen+Shot+2012-04-11+at+10.29.11+AM.png"></p>

<p>This is not a big issue at all, just a conflict on the <strong><code>img</code></strong> tag and its style (max-width) coming from Twitter Bootstrap. The quick fix :</p>

<ul>
<li>override the style of the <strong><code>img</code></strong> tag for the div that contains your map.</li>
</ul>


<p>For example in my case the div for my map is define as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;resultriMap&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You just need to add a new style to your page with the following definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="o">&lt;</span><span class="nt">style</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">#resultriMap</span> <span class="nt">img</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">max-width</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;/</span><span class="nt">style</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After adding this to my page the map is correctly printed as you can see in the following screenshot :</p>

<p><img src="http://3.bp.blogspot.com/-BZje60RpKWo/T4VESYjt7gI/AAAAAAAAAT8/Az1xV8Xv2Dg/s320/Screen+Shot+2012-04-11+at+10.29.42+AM.png"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/19/sap-cloud-inside-build-and-run-applications-in-the-cloud/">SAP Cloud Inside : Build and Run Applications in the Cloud</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-02-19T23:56:56+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>11:56 pm</span></time>
        
           | <a href="/blog/2012/02/19/sap-cloud-inside-build-and-run-applications-in-the-cloud/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2012/02/19/sap-cloud-inside-build-and-run-applications-in-the-cloud/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week I was invited to present eXo Cloud IDE during the SAP Cloud Inside. This SAP Community event was a great opportunity to discuss about the cloud with an interesting point of view: the impact of the cloud for SAP customers (especially administrators and developers).</p>

<p>During this presentation I have introduced the <a href="http://www.cloud-ide.com/">eXo Cloud IDE</a>, and I did a demonstration in which O have built and deployed applications : Open Social Gadgets, Ruby on Rails and Java/Spring, and explain how it could be extended to SAP business services.</p>

<p>Here the slides that I have used during this presentation:</p>

<iframe src="http://www.slideshare.net/slideshow/embed_code/95672 " width="595" height="446" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen></iframe>


<p></p>

<p><strong><a href="http://www.slideshare.net/tgrall/sap-cloud-inside-develop-and-deploy-on-the-cloud" title="SAP Cloud Inside : Develop and Run on the Cloud">SAP Cloud Inside : Develop and Run on the Cloud</a></strong></p>

<p>Remember that you can register yourself to the <a href="http://www.cloud-ide.com/">eXo Cloud IDE</a> Service and start develop application from your browser.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/19/exo-platform-integrate-twitter-and-exo-activity-stream/">eXo Platform : Integrate Twitter and eXo Activity Stream</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2012-01-19T01:05:07+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2012</span></span> <span class='time'>1:05 am</span></time>
        
           | <a href="/blog/2012/01/19/exo-platform-integrate-twitter-and-exo-activity-stream/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2012/01/19/exo-platform-integrate-twitter-and-exo-activity-stream/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>eXo Platform 3.5 provides many extension points and API for developers, allowing them to create very cool stuff.</p>

<p>I have developed a small extension that allows any user to associate his Twitter account to his eXo Platform account. This extension simply post on your Twitter account when you write a message with a special hashtag (#tw).</p>

<p>This is a very quick development that I have done while waiting for my kids, so I still have things to integrate to provide complete feature, but this is a good example to show how you can extend the platform.</p>

<p>You can view it in action in this video:</p>

<iframe width="560" height="420" src="http://www.youtube.com/embed/KN0jsOdauPU?color=white&theme=light"></iframe>


<p>You can download the source code and the binaries from this <a href="https://github.com/tgrall/exo-twitter-integration">GitHub project</a>. I hope to find some time to complete the feature, and document this use case.</p>

<p>Enjoy!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/05/how-to-watch-youtube-videos-offline-on-os-x/">How to Watch YouTube Videos Offline (on OS X)?</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-12-05T01:53:20+01:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>1:53 am</span></time>
        
           | <a href="/blog/2011/12/05/how-to-watch-youtube-videos-offline-on-os-x/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2011/12/05/how-to-watch-youtube-videos-offline-on-os-x/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Lately I have been traveling a lot, and I was not able to access the internet all the time; but I still want to look at some YouTube video, for example the greate Google I/O Sessions&hellip;</p>

<p>My needs are simple :</p>

<ul>
<li>running on OS X (Lion)</li>
<li>download the video easily</li>
<li>no need to convert the file (to be able to read the file as soon as possible)</li>
<li>free</li>
</ul>


<p>After some basic research, I found an easy way to achieve this using the following softwares:</p>

<ul>
<li><a href="http://www.enolsoft.com/free-youtube-downloader-hd-for-mac.html">Enolsoft Free YouTube Downloader HD</a> : this software allows you to download easily the YouTube FLV on your hard drive.</li>
<li><a href="http://www.videolan.org/vlc/download-macosx.html">VLC Media Player</a> : to play the FLV file locally.</li>
</ul>


<p><img src="http://2.bp.blogspot.com/-8j7u3NgOGkQ/TtyWZDO6-_I/AAAAAAAAATQ/rNkRF1JNUYE/s400/capture-youtube-video.png"></p>

<p>Enjoy!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/20/installing-memcached-on-mac-os-x-and-using-it-in-java/">Installing Memcached on Mac OS X and Using It in Java</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-11-20T07:12:21+01:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>7:12 am</span></time>
        
           | <a href="/blog/2011/11/20/installing-memcached-on-mac-os-x-and-using-it-in-java/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2011/11/20/installing-memcached-on-mac-os-x-and-using-it-in-java/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Introduction</h3>

<p>In this article I will explain how you can:</p>

<ol>
<li>Install and Configure Memcached on Mac OS X</li>
<li>Use Memcached in your Java Application</li>
</ol>


<p>I won&rsquo;t go in too much detail about the benefits of using a distributed cache in your applications, but let&rsquo;s at least provide some use cases for applications that are running in the context of an enterprise portal, eXo Platform in my case - <em>surprising isn&rsquo;t?</em> And I will show this in another post.</p>

<p>We have many reasons to use a cache (distributed or not), in the context of enterprise portal, let&rsquo;s take a look to some of these reasons:</p>

<ul>
<li>A portal is used to aggregate data in a single page. These data could come from different sources : Web Services, Database, ERP, &hellip;.. and accessing the data in real time could be costly. So it will be quite interesting to cache the result of the call when possible.</li>
<li>If the portal is used to aggregate many data from many sources, it is sometime necessary to jump into another application to continue some operation. A distributed and shared cache could be used to manage some context between different applications running in different processes (JVM or even technologies)
These are two example where a shared cache could be interesting for your portal based applications, we can find many other reason.</li>
</ul>


<p>Note that the Portlet API (JSR-286) contains already a cache mechanism that cache the HTML fragment, and that eXo Platform also provide a <a href="http://docs.jboss.org/exojcr/1.14.0-CR4/developer/en-US/html/ch-cache.html">low level cache</a>, based on <a href="http://www.jboss.org/jbosscache">JBoss Cache</a>.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2011/11/20/installing-memcached-on-mac-os-x-and-using-it-in-java/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/02/jax-rs-jersey-and-json-single-element-arrays/">JAX-RS: Jersey and JSON Single Element Arrays</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-09-02T15:30:26+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2011</span></span> <span class='time'>3:30 pm</span></time>
        
           | <a href="/blog/2011/09/02/jax-rs-jersey-and-json-single-element-arrays/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2011/09/02/jax-rs-jersey-and-json-single-element-arrays/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week I have been struggling with a small issue while developing a service using Jersey.</p>

<p>The goal of this service is to provide JSON object to my Web application, so called directly from the browser. This service returns in a JSON array a list of Employees, something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span><span class="s2">&quot;employee&quot;</span><span class="o">:</span><span class="p">[</span>
</span><span class='line'><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;jdoe@example.com&quot;</span><span class="p">,</span><span class="s2">&quot;firstName&quot;</span><span class="o">:</span><span class="s2">&quot;John&quot;</span><span class="p">,</span><span class="s2">&quot;lastName&quot;</span><span class="o">:</span><span class="s2">&quot;Doe&quot;</span><span class="p">},</span>
</span><span class='line'><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;mmajor@example.com&quot;</span><span class="p">,</span><span class="s2">&quot;firstName&quot;</span><span class="o">:</span><span class="s2">&quot;Mary&quot;</span><span class="p">,</span><span class="s2">&quot;lastName&quot;</span><span class="o">:</span><span class="s2">&quot;Major&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So an &ldquo;employee&rdquo; array, this is perfect and expected, but when my service returns a single element the returned object looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span><span class="s2">&quot;employee&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;jdoe@example.com&quot;</span><span class="p">,</span><span class="s2">&quot;firstName&quot;</span><span class="o">:</span><span class="s2">&quot;John&quot;</span><span class="p">,</span><span class="s2">&quot;lastName&quot;</span><span class="o">:</span><span class="s2">&quot;Doe&quot;</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see brackets <strong>[&hellip;]</strong> are missing around the employee item. This is an issue since your client code is expecting an array.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2011/09/02/jax-rs-jersey-and-json-single-element-arrays/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/31/how-to-create-a-new-content-list-template-for-exo-platform-3/">How to Create a New Content List Template for eXo Platform 3</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-08-31T23:50:18+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2011</span></span> <span class='time'>11:50 pm</span></time>
        
           | <a href="/blog/2011/08/31/how-to-create-a-new-content-list-template-for-exo-platform-3/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2011/08/31/how-to-create-a-new-content-list-template-for-exo-platform-3/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Introduction</h3>

<p>eXo Platform provide many powerful features to manipulate and expose any type of content on a page. This is due to the fact that eXo stores the all the content in its Java Content Repository (JCR) and render the content on a page using Groovy Templates.</p>

<p>In this how to you will learn how you can create and use template that are used in the &ldquo;Content List&rdquo; portlet. For example in the ACME sample site you can show the content in 1 or 2 columns just by selecting different templates.</p>

<p><img src="http://2.bp.blogspot.com/-aEn1Gp75nD4/TbbALBRftVI/AAAAAAAAAPc/3JLHePfFkuM/s200/one-col-view.png">
One Column View</p>

<p><img src="http://4.bp.blogspot.com/-xSn44HNlBZ8/TbbAMSRDq7I/AAAAAAAAAPg/YEu715pX3WE/s200/two-col-view.png">
Two Columns View</p>

<h3>Creating a new Content List Template</h3>

<p>In this section you will learn how to create a new template using the eXo IDE. Before writing the new template it is important to learn where the templates are stored.</p>

<h4>eXo Content Service: Template Storage</h4>

<p>Like many things inside eXo Platform, the eXo JCR is used to stored the templates. Templates are just a special type of content. This allows developers to easily write and test code without having complex deployment process, but also it make the life easy to export a running configuration to another one. For this you just need to use the standard JCR export/import features.</p>

<p>All the template and eXo Content Service configurations are stored inside a specific JCR workspace named : <code>dms-system</code>.</p>

<p>Each template type (Document Type, Content List, &hellip;.) is stored in a specific location. In our case we want to work on the &ldquo;Content List&rdquo; portlet so the template are stored inside the following folder:</p>

<ul>
<li><code>/exo:ecm/views/templates/content-list-viewer/list/</code></li>
</ul>


<p>Just for the fun of it, let&rsquo;s inspect this folder using the eXo CRaSH utility. If you are not interested you can jump to the next section. CRaSH is a shell for Java Content Repositories, the source of CRaSH is available on <a href="http://code.google.com/p/crsh/">Google Code</a>. So in a terminal window:</p>

<p>1-  Connect to CRaSH using telnet client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> telnet 127.0.0.1 5000
</span></code></pre></td></tr></table></div></figure>


<p>2-  Connect to the JCR workspace using the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> connect -u root -p gtn -c portal dms-system&lt;/span&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Where: -u is the user, -p the password, -c the Portal Container, and dms-system the workspace to use</p>

<p>3-  Move the the folder that contains all the templates for the Content List portlet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nb">cd</span> /exo:ecm/views/templates/content-list-viewer/list/
</span></code></pre></td></tr></table></div></figure>


<p>4-  List all the templates using the <code>ls</code> command
You can see the list of all the templates available for the Content List portlet.</p>

<h4>Create a new template using the eXo IDE</h4>

<p>Let&rsquo;s now create a new template using the IDE. For this be sure you are connected with a user that is part of the <code>/Developer</code> group. For simplicity reason I am using the <code>root</code> user.</p>

<p>The first important step is to go the the template location using the following steps:</p>

<p>1-  Access the IDE: click on <code>My Spaces &amp;gt; IDE</code>.</p>

<p>2-  Switch <code>dms-system</code> workspace: In the IDE menu click <code>My Spaces &amp;gt;on Window &amp;gt; Select Workspace</code>. And select the dms-system location in the dialog box and click OK.</p>

<p>3-  In the file structure on the left navigate to the template location :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/exo:ecm/views/templates/content-list-viewer/list/
</span></code></pre></td></tr></table></div></figure>


<p>4-  Create a new template : In the IDE Menu click on <code>File &amp;gt; New &amp;gt; Groovy Template</code></p>

<p>5-  Save the file as &ldquo;<code>MyNewTemplate.gtmpl</code>&rdquo;</p>

<p>6-  Enter some basic code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span>This is my template<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>The date is <span class="err">&lt;</span>= new Date()&gt;
</span></code></pre></td></tr></table></div></figure>


<p>7-  Save the template</p>

<p>8-  Go back to the Home page of the Acme Site</p>

<p>9-  Switch to Edit more by selecting Edit in the top right drop down list.</p>

<p><img src="http://3.bp.blogspot.com/-EsSUDUdUo_8/TbbRJZlZlHI/AAAAAAAAAPk/5iTn-NoC-JE/s200/edit-mode.png"></p>

<p>10-  Move you mouse at the top of the list of news and click on the preference button: <img src="http://1.bp.blogspot.com/-ksljDe3llf4/TbbSIOl0DII/AAAAAAAAAPs/C0eBv-SJ25I/s200/PreferencesIcon.png"></p>

<p>11-  In the list of templates, select the &ldquo;MyNewTemplate&rdquo;, and click save.</p>

<p><img src="http://2.bp.blogspot.com/-7hT5osGXK1w/TbbTTJ7ZKSI/AAAAAAAAAP0/--VCTefhrSI/s320/select-template.png"></p>

<p>We have created our new template, and use it on a page. We should now add some more interesting code to the template to really loop over the content based on the portlet configuration. But before this it is important to talk about caching and code modification.</p>

<h4>eXo Template and Cache</h4>

<p>To improve performances and a running system, the compiled version of the template is by default cached. This is why when you are modifying a template you do not see any change. We have two ways to work around this:</p>

<ul>
<li>Run eXo Platform in Debug mode, in this case nothing is cached</li>
<li>Invalidate the cache manually using JMX</li>
</ul>


<p>Since working with no cache at all is not an option, here is the MBean you have to use to invalidate the Template Service cache:</p>

<ul>
<li><code>exo:portal="portal",service=cache,name="TemplateService"</code>, then call the <code>clearCache</code> operation on it</li>
</ul>


<p>I do use JConsole for this, but you can use any method to call your MBeans operation.</p>

<p><img src="http://1.bp.blogspot.com/-ZuMQz-VHBYY/TbldhSRY2NI/AAAAAAAAAP8/pb09UoA9_b4/s200/TemplateServiceCacheMbean.png"></p>

<p>Do not forget to call this operation each time you modify your template to be sure eXo recompile the template.</p>

<h4>Accessing Content in the template</h4>

<p>The current code of the template is really simple, you need now to add code to print the content in the page. For this we will be using some eXo Content programming, once again in the IDE.</p>

<p>If you are not interested to have detailed explanation of the code you can go to the complete source code <a href="javascript:%20alert(">here</a>.</p>

<p>The template used by the Content List portlet is based on the following Java class <code>org.exoplatform.wcm.webui.clv.UICLVPresentation</code>, this class is responsible to set the complete context that you can use in the template such as:</p>

<ul>
<li>The folder or category that contains the content to show. The &ldquo;Folder Path&rdquo; field in the preference screen</li>
<li>The display settings: title, number of documents, elements to show, &hellip;</li>
</ul>


<p>Here is the code to access these preferences:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="c1">// import all the classes need in the template</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.jcr.Node</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.wcm.webui.paginator.UICustomizeablePaginator</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.wcm.webui.clv.UICLVPortlet</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.wcm.webui.Utils</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.services.wcm.core.NodeLocation</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// get the portlet preferences</span>
</span><span class='line'><span class="kt">def</span> <span class="n">header</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getHeader</span><span class="o">();</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowRssLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowRssLink</span><span class="o">();</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowHeader</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_HEADER</span><span class="o">);</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowRefresh</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_REFRESH_BUTTON</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowTitle</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_TITLE</span><span class="o">);</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowDate</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_DATE_CREATED</span><span class="o">);</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_LINK</span><span class="o">);</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowReadmore</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_READMORE</span><span class="o">);</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowImage</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_ILLUSTRATION</span><span class="o">)</span> <span class="o">;</span>
</span><span class='line'><span class="kt">def</span> <span class="n">isShowSummary</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">isShowField</span><span class="o">(</span><span class="n">UICLVPortlet</span><span class="o">.</span><span class="na">PREFERENCE_SHOW_SUMMARY</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">uicomponent</span> object is defined by the container class of the portlet that calls the template. This class contains many utility methods. In the code above I retrieve all the preferences of the portlet, since the name are self-explanatory it is not necessary to detail them, especially when you look at the preferences screen below:</p>

<p><img src="http://3.bp.blogspot.com/-bDIJtSVaD9A/TblkjTr2wMI/AAAAAAAAAQE/6mRLmEYqpsE/s320/preference-screen.png"></p>

<p>Now that the template has all the preferences, it is time to loop on the content on print the information.</p>

<p>The eXo Content Service provides API to manipulate the content, including pagination of content. The idea behind this is to let the Content Service manage the JCR query, sorting, caching and pagination of data. So in your template you will mainly manage two classes to loop through the content to show:</p>

<ul>
<li><code>uicomponent.getUIPageIterator()</code> a paginator object that is configured based on the portlet preferences</li>
<li><code>uicomponent.getCurrentPageData()</code>contains a list of the content (JCR Nodes) that should print on the current page</li>
</ul>


<p>So let&rsquo;s print all the content of the page as a simple HTML list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;ul</span> <span class="na">style=</span><span class="s">&quot;margin: 20px&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%
</span><span class='line'>for (viewNode in uicomponent.getCurrentPageData()) {
</span><span class='line'>  def title = viewNode.getProperty(&quot;exo:title&quot;).getString();
</span><span class='line'>  print(&quot;<span class="nt">&lt;li&gt;</span>$title<span class="nt">&lt;/li&gt;</span>&quot;);
</span><span class='line'>}
</span><span class='line'>%&gt;
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just  copy this code in your template, save it, refresh the cache&hellip; and go to your page. You should see the list of the content in a simple HTML list.</p>

<p>On each content (Node), eXo Content API provides some helper method to easily manipulate the content and avoid using the JCR API directly. In the following code you can see the most important methods accessing content properties:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">def</span> <span class="n">itemName</span> <span class="o">=</span> <span class="n">viewNode</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">webdDavLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getWebdavURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemDateCreated</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getCreatedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemModifiedDate</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getModifiedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemAuthor</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">imgSrc</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getIllustrativeImage</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemTitle</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'><span class="n">def</span> <span class="n">itemSummary</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getSummary</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>One important point is the fact that these methods are responsible of many things, for example: formatting dates, returning complete URLs depending of the context of the portlet.</p>

<p>Based on these methods you can now work on the presentation of the information on the page. Let&rsquo;s for example print the image, the title and allow user to click on the title to go in the detail view of the article. This is done simply using the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;%</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="n">viewNode</span> <span class="n">in</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getCurrentPageData</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemName</span> <span class="o">=</span> <span class="n">viewNode</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">webdDavLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getWebdavURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemDateCreated</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getCreatedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemModifiedDate</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getModifiedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemAuthor</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">imgSrc</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getIllustrativeImage</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemTitle</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemSummary</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getSummary</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;overflow: auto;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;$imgSrc&quot;</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;$itemLink&quot;</span><span class="o">&gt;</span><span class="n">$itemTitle</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">$itemSummary</span>
</span><span class='line'>  <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For simplicity reason, this code does not manage any null value. Also the template do not deal with the portlet preferences such as the &ldquo;Header&rdquo;, &ldquo;RSS&rdquo; links and so on, do not hesitate to do it if you want.</p>

<p>The Web site should look like the following image:</p>

<p><img src="http://3.bp.blogspot.com/-JvoTBERVTH0/Tbmf9tYRcUI/AAAAAAAAAQM/sdUy2gs39ks/s320/new-site-001.png"></p>

<p>The last important point is to add the support for the in context editing that allows the user to edit the content directly from the template. Once again this is done with a method of the <code>uicomponent</code> object, that create a DIV around the content. Let&rsquo;s add this to the template:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;%</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="n">viewNode</span> <span class="n">in</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getCurrentPageData</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemName</span> <span class="o">=</span> <span class="n">viewNode</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">webdDavLink</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getWebdavURL</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemDateCreated</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getCreatedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemModifiedDate</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getModifiedDate</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemAuthor</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getAuthor</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">imgSrc</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getIllustrativeImage</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemTitle</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>  <span class="n">def</span> <span class="n">itemSummary</span> <span class="o">=</span> <span class="n">uicomponent</span><span class="o">.</span><span class="na">getSummary</span><span class="o">(</span><span class="n">viewNode</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">div</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;overflow: auto;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;%=</span><span class="n">uicomponent</span><span class="o">.</span><span class="na">addQuickEditDiv</span><span class="o">(</span><span class="s">&quot;MyTemplateContentEditor&quot;</span><span class="o">,</span> <span class="n">viewNode</span><span class="o">)%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;$imgSrc&quot;</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;$itemLink&quot;</span><span class="o">&gt;</span><span class="n">$itemTitle</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">$itemSummary</span>
</span><span class='line'>  <span class="o">&lt;</span> <span class="o">/</span><span class="n">div</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The lines 15 and 19 are new in this template and provide support for Quick Edit feature.</p>

<p>Done! We have created a new template for eXo Platform Content Service using embedded IDE.</p>

<h4>Conclusion</h4>

<p>In this article you have learned how to create a new template for eXo Content Service, with some basic steps:</p>

<ul>
<li>Create a new Groovy Template using the eXo IDE</li>
<li>Edit this template using the eXo Java Content API</li>
<li>Configure your Content List portlet instance on a page to select the new template</li>
</ul>


<p>You can now create your own templates and use your imagination to add cool features to your site (for example the carrousels you see on the <a href="http://www.exoplatform.com/">eXo site</a> are using custom CLV template.)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/11/how-to-protect-your-rest-service-and-gadget-in-exo-platform/">How to Protect Your REST Service and Gadget in eXo Platform</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-04-11T20:22:56+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>8:22 pm</span></time>
        
           | <a href="/blog/2011/04/11/how-to-protect-your-rest-service-and-gadget-in-exo-platform/#disqus_thread"
             data-disqus-identifier="http://tgrall.github.io/blog/2011/04/11/how-to-protect-your-rest-service-and-gadget-in-exo-platform/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>During a partner workshop I was showing to the developers how the eXo IDE can help them to develop new features quickly and push them to the users in few minutes. A person asked me if it is possible to put some restriction in services and gadgets based on user profile.</p>

<p>As you can guess the answer is YES WE CAN!</p>

<ul>
<li>How to access the security context in a REST service</li>
<li>How to check is a user is member of a  group and manage permission from this information</li>
<li>How to consume this service in a gadget and leverage the security to protect resources</li>
</ul>


<p><img src="http://1.bp.blogspot.com/-eR15bpCaiXo/TZ8yp1kkLYI/AAAAAAAAAPM/8Az5EVfVrzU/s200/rest-no-access.png">
Not-authorized</p>

<p><img src="http://2.bp.blogspot.com/-wcfWsRgV8Xc/TZ8ypzrBsLI/AAAAAAAAAPE/U9VnHpc3q9M/s200/rest-access.png">
Authorized</p>

<p>If you are not interested to follow steps by step the explanations you can directly jump to the complete <a href="#completeService">REST Service code</a> or download the full eXo IDE Project from <a href="https://github.com/tgrall/sample-gadget-with-security">GitHub</a></p>

<h3>Access the User Profile from your REST Service</h3>

<p>As you probably know eXo Platform uses <a href="http://jcp.org/en/jsr/detail?id=311">JAX-RS</a> as API to develop and deploy REST Services. eXo developers can create REST services using their favorite Java IDE, but here I am using the eXo IDE package with <a href="http://www.exoplatform.org/company/public/website/platform">eXo Platform</a>.</p>

<p>To access the security and user information in your service method it is possible to use the <a href="http://jersey.java.net/nonav/apidocs/1.5/jersey/javax/ws/rs/core/SecurityContext.html">SecurityContext</a> class of the JAX-RS API.  Your method signature will look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.PathParam</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.Response</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.SecurityContext</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.Context</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/system&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;application/json&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SystemInformationService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;information&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getSystemInfo</span><span class="o">(</span><span class="nd">@Context</span> <span class="n">SecurityContext</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In lines 7 and 8, I import the classes needed to inject the security context in the method <code>getSystemInfo()</code> in line 16. For now let&rsquo;s forget about the other part of the code.</p>

<p>With the Security Context object you can now access many things in your code. Two methods are quite interesting for this example: <code>getUserPrincipal()</code> and <code>isUserInRole()</code>, since our goal is to check if a user is allowed to execute or not a part of the business logic.</p>

<p>It is important here to remember that we cannot directly use the <code>isUserInRole()</code> method since this method uses the logical JavaEE roles that are defined at the Java application level. In our case we are interested to know if a user is present in a &ldquo;eXo User Identity&rdquo; Group, for example member of the <code>/platform/administrators group</code>. This information is populated during the login process and comes from the user provider that could be LDAP, the eXo Database or JCR, or any other source since developers can extend this API to plug their own provider.</p>

<p>Let&rsquo;s create an helper method that check, using the eXo Identity Service, if the user that executes the method is present in a group.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.ExoContainer</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.ExoContainerContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.component.ComponentPlugin</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.services.security.Identity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.services.security.IdentityRegistry</span><span class="o">;</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isMemberOf</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">String</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">ExoContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="n">ExoContainerContext</span><span class="o">.</span><span class="na">getCurrentContainer</span><span class="o">();</span>
</span><span class='line'>  <span class="n">IdentityRegistry</span> <span class="n">identityRegistry</span> <span class="o">=</span> <span class="o">(</span><span class="n">IdentityRegistry</span><span class="o">)</span> <span class="n">container</span><span class="o">.</span><span class="na">getComponentInstanceOfType</span><span class="o">(</span><span class="n">IdentityRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Identity</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">identityRegistry</span><span class="o">.</span><span class="na">getIdentity</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">identity</span><span class="o">.</span><span class="na">isMemberOf</span><span class="o">(</span> <span class="n">group</span> <span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this method is quite simple, it takes as parameter:</p>

<ul>
<li>the name of the user, that you can get from the <code>UserPrincipal.getName()</code> method</li>
<li>the eXo Group you want to check, for example <code>/platform/administrator</code></li>
</ul>


<p>You can now call this method from your resource to check the user, and code the &ldquo;permission business logic&rdquo;. The method could now looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@GET</span>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;information&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Response</span> <span class="nf">getSystemInfo</span><span class="o">(</span><span class="nd">@Context</span> <span class="n">SecurityContext</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">groupToCheck</span> <span class="o">=</span> <span class="s">&quot;/platform/administrators&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">isMemberOf</span><span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">groupToCheck</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;NOT-ALLOWED&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;ALLOWED&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span>  <span class="n">response</span>   <span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example for simplicity reason I have hard coded the group to check, you can obviously use smarter code to user external configuration to inject a list of group to check for example. I manage the security logic of my method using simple if statement and return a string. You can also depending of your needs, manage the status of your response and use HTTP Code for example return an <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">HTTP 403</a>. For this you just need to return a different response using following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">Response</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">FORBIDDEN</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>For simplicity reason I will stay with a single Response status (OK) and manage the permission in my client code.</p>

<h3>Complete REST Service</h3>

<p>Let&rsquo;s take a look to the full service now, this service allows administrators to get the list of the System Properties, other users get an status string &ldquo;NOT-ALLOWED&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.GET</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.PathParam</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.Response</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.MediaType</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.CacheControl</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.SecurityContext</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.ws.rs.core.Context</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.ExoContainer</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.ExoContainerContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.container.component.ComponentPlugin</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.services.security.Identity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.exoplatform.services.security.IdentityRegistry</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/system&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;application/json&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SystemInformationService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;information&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getSystemInfo</span><span class="o">(</span><span class="nd">@Context</span> <span class="n">SecurityContext</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">groupToCheck</span> <span class="o">=</span> <span class="s">&quot;/platform/administrators&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="n">SimpleResponseWrapper</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleResponseWrapper</span><span class="o">();</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">isMemberOf</span><span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">groupToCheck</span><span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="s">&quot;NOT-ALLOWED&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="s">&quot;OK&quot;</span><span class="o">;</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CacheControl</span> <span class="n">cacheControl</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CacheControl</span><span class="o">();</span>
</span><span class='line'>    <span class="n">cacheControl</span><span class="o">.</span><span class="na">setNoCache</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="n">cacheControl</span><span class="o">.</span><span class="na">setNoStore</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span>  <span class="n">response</span>   <span class="o">,</span> <span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">).</span><span class="na">cacheControl</span><span class="o">(</span><span class="n">cacheControl</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isMemberOf</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span><span class="n">String</span> <span class="n">role</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ExoContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="n">ExoContainerContext</span><span class="o">.</span><span class="na">getCurrentContainer</span><span class="o">();</span>
</span><span class='line'>    <span class="n">IdentityRegistry</span> <span class="n">identityRegistry</span> <span class="o">=</span> <span class="o">(</span><span class="n">IdentityRegistry</span><span class="o">)</span> <span class="n">container</span><span class="o">.</span><span class="na">getComponentInstanceOfType</span><span class="o">(</span><span class="n">IdentityRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Identity</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">identityRegistry</span><span class="o">.</span><span class="na">getIdentity</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">identity</span><span class="o">.</span><span class="na">isMemberOf</span><span class="o">(</span> <span class="n">role</span> <span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleResponseWrapper</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">status</span><span class="o">;</span>
</span><span class='line'>  <span class="n">Object</span> <span class="n">data</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To summarize:</p>

<ul>
<li>Line 24 : the <span style="font-family: Courier New,Courier,mono">SecurityContext</span> is injected to the method</li>
<li>Line 26 : Initialization of a simple <span style="font-family: Courier New,Courier,mono">ResponseWrapper</span> defined on line 51, that contains a status and data. That will be serialized in JSON by the eXo REST engine.* Line 28 : the method check if a user is connected and member of <span style="font-family: Courier New,Courier,mono">/platform/administrator</span>. If not it send response with the status NO-ALLOWED.</li>
<li>Line 31/32 : The response object is sent. This response contains an OK status and the data (system properties list)</li>
<li>Line 42 : Using the eXo Identity Service, the method check if the connected user is member of a specific group.</li>
</ul>


<h3>Consume the service into a Gadget</h3>

<p>I can now take this service and consume it into an Gadget. I also develop this Gadget using the eXo IDE.</p>

<p>The following code shows the Javascript part of the Gadget that calls the service, check the security and push the response content in Gadget body. For productivity I use JQuery framework.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">printInfo</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">htmlResponse</span><span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&quot;OK&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">htmlResponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;tr&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">htmlResponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;td&gt;&#39;</span><span class="o">+</span> <span class="nx">index</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">htmlResponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;/tr&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#systemInfo&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">htmlResponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;Not permitted&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#systemInfo&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#systemInfo&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">htmlResponse</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="nx">gadgets</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">adjustHeight</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sysInfoContainer&#39;</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">()</span>  <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">loadInformationFromServer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/rest/private/system/information&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span> <span class="nx">printInfo</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>   <span class="p">}</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">loadInformationFromServer</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gadgets</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">registerOnLoadHandler</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here some quick explanation about this code:</p>

<ul>
<li>Line 23: To call the REST service, I use the <span style="font-family: Courier New,Courier,mono">$.getJSON()</span> method. This method is really easy to use when you are executing the Gadget is in the same container than the portal that consumes it. When you are using the gadget.io.MakeRequest is interesting to proxy a request and you need to re-authenticate, for example using oAuth.</li>
<li>Line 3 : This is the call back method, as you can see in this method I use the <span style="font-family: Courier New,Courier,mono">ResponseWrapper</span> to check the code in the status attribute. Depending of the status OK or not I do print the value.</li>
</ul>


<h3>Conclusion</h3>

<p>In this how-to you have learned how to:</p>

<ul>
<li>Get the security context in your REST Service</li>
<li>Check the membership of a user using the eXo Identity Service</li>
<li>Create a gadget that consume this service and expose only data to user with correct profile</li>
<li>Download the full project from <a href="https://github.com/tgrall/sample-gadget-with-security">GitHub</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/09/02/getting-with-redis-streams-and-java/">Getting With Redis Streams &amp; Java</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/23/getting-started-with-mapr-db-json-rest-api/">Getting Started With MapR-DB JSON REST API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/08/getting-started-with-mapr-db-table-replication/">Getting Started With MapR-DB Table Replication</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/20/getting-started-with-kafka-rest-proxy-for-mapr-streams/">Getting Started With Kafka REST Proxy for MapR Streams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/02/getting-started-with-mqtt/">Getting Started With MQTT and Java</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/tgrall">@tgrall</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tgrall',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog2 -->
<ins class="adsbygoogle"
style="display:inline-block;width:120px;height:240px"
data-ad-client="ca-pub-0681046388042833"
data-ad-slot="9144931072"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Tug Grall -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'true';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
